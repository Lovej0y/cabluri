S/MIME v3.1 messages exchange
=============================

Send:
  + [message]     <- <input>
  + [message]     -> signed    with sender's    [private sign.pem]    -> [message.sig]
  + [message.sig] -> encrypted with recipient's [X.509   encrypt.pem] -> [message.out]
  + [message.out] -> <send>

Receive:
  + [message.out] <- <receive>
  + [message.out] -> decrypted with recipient's [private decrypt.pem] -> [message.sig]
  + [message.sig] -> verified  wrt  sender's    [X.509   verify.pem]  -> [message]
  +               -> r-signed  with recipient's [private sign.pem]    -> [receipt.sig]
  + [receipt.sig] -> encrypted with sender's    [X.509   encrypt.pem] -> [receipt.out]
  + [receipt.out] -> <send>

Acknowledge:
  + [receipt.out] <- <receive>
  + [receipt.out] -> decrypted with sender's    [private decrypt.pem] -> [receipt.sig]
  + [receipt.sig] -> verified  wrt  recipient's [X.509   verify.pem]  +  [message.sig]
  + (ack)         -> <send>


Protocol:
  + <shost,rhost>/cable/certs/<suser,ruser>/{ca,verify,encrypt}.pem are always accessible
  + <shost>/cable/queue/<msgid> is accessible until receipt verified
  + <rhost>/cable/rqueue/<msgid> is accessible until receipt verification acked
  + communication is stateless

  [sender fetches <rhost>/cable/certs/<ruser>/{ca,encrypt,verify}.pem]
  [... sender prepares the signed/encrypted message with receipt request ...]
  [sender publishes (<shost>)/cable/queue/<msgid>]

  -> MSG <shost> <suser> <msgid>        (msgid = 12 random lowercase alnum chars)

  [recipient fetches <shost>/cable/queue/<msgid>]
  [recipient fetches <shost>/cable/certs/<suser>/{ca,encrypt,verify}.pem]
  [... recipient verifies message and prepares the signed/encrypted receipt ...]
  [recipient publishes (<rhost>)/cable/rqueue/<msgid>]

  <- RCP <msgid>

  [sender fetches <rhost>/cable/rqueue/<msgid>]
  [... sender verifies the receipt ...]
  [sender removes /cable/queue/<msgid>]

  -> ACK <msgid>

  [recipient removes /cable/rqueue/<msgid>]


Other possible commands:

  <- REJ <msgid>              (message rejected: <msgid> in use, crypto failure, ...)

  [sender removes /cable/queue/<msgid>]

  -> RJR <msgid>              (receipt rejected: crypto failure, ...)

  [recipient removes /cable/rqueue/<msgid>]
