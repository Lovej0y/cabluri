#!/bin/sh -e

if [ "$1" = fork ]; then
    nginxflag=/var/lib/init.d/started/nginx
    pidfile=/var/run/cabled.pid

    # If nginx is not running, perform initialization tasks
    if [ ! -e ${nginxflag} ]; then
        sudo -n -u "${CHUSER}" "$0" init
    fi

    sudo -n -u "${CHUSER}" -s /bin/sh -c "$0"' & echo $!' > ${pidfile}
    exit
fi


# Setup restricted environment
. /usr/local/libexec/suexec/suprofile


# Preliminary variables
msgidre='[[:xdigit:]]{40}'
queue=${HOME}/persist/cables/queue
rqueue=${HOME}/persist/cables/rqueue


# Initialization tasks
if [ "$1" = init ]; then
    rm -rf --one-file-system `find ${rqueue} -maxdepth 1 -type d \
        -regextype posix-egrep -regex ".*/${msgidre}\.new"`
    exit
fi


# Variables
prefix=`dirname $0`
loop="${prefix}"/loop
inpid=0
maxproc=50


# Set some traps
trap 'set +e; kill ${inpid} 2>/dev/null' 0
trap : INT QUIT TERM SEGV


exec 1>>${TMPDIR}/cabled.log 2>&1

# Read inotify events (close events may be ignored)
# NOTE: inotifywait dies on blocking output
# TODO: umount events (wait for mount), synthetic events (retries),
#       message timeout, proper signal handling, proper logging
while :; do
    # Sanitize the output line (also cleans inotifywait's failure status,
    # and will get inotifywait killed if parent process is killed)
    event=`inotifywait -q -e moved_to -e attrib --format '%w:%f' ${queue} ${rqueue} \
               | tr -cd '[:lower:][:digit:]/:.'`

    if echo "${event}" | egrep -q "^(${queue}|${rqueue})/:${msgidre}(\.del)?\$"; then
        qtype="${event%%/:*}"
        dirid="${event#*:}"

        if [ "${qtype}" = ${queue} ]; then
            qtype=queue
        elif [ "${qtype}" = ${rqueue} ]; then
            qtype=rqueue
        else
            qtype=unknown
        fi

        # Identify loop-related processes by flock (pipe clears failure status)
        pcount=`pgrep -u ${USER} -x flock | wc -l`
        if [ "${pcount}" -lt ${maxproc} ]; then
            logger -p 6 -t cabled "processing ${qtype}/${dirid}"
            "${loop}" ${qtype} "${dirid}" &
        else
            logger -p 4 -t cabled "too many processes, ignoring ${qtype}/${dirid}"
        fi
    else
        logger -p 7 -t cabled "ignoring event: ${event}"
    fi
done
