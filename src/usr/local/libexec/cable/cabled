#!/bin/sh -e

# Setup restricted environment
# (rely on init via sudo to set up TMPDIR)
. /usr/local/libexec/suexec/suprofile


# Preliminary variables
mpoint=${HOME}/persist
queue=${mpoint}/cables/queue
rqueue=${mpoint}/cables/rqueue


# Initialization tasks
if [ "$1" = init ]; then
    find ${rqueue} -maxdepth 1 -type d -regextype posix-egrep \
                   -regex "${rqueue}/${msgidre}\.new" -print0 \
        | xargs -0 rm -rf --one-file-system --
    exit
fi


# Variables
prefix="${0##*/}"
prefix="${0%${prefix}}"
daemon="${prefix}"daemon


exec 1>>${TMPDIR}/cabled.log 2>&1


# Let fuse-vfs inotify emulation stabilize
sleep 30


# Launch the inotify-based daemon
# TODO: proper logging
exec "${daemon}" ${mpoint} ${queue} ${rqueue}
